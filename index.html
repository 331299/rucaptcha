<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>RuCaptcha by huacnlee</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">RuCaptcha</h1>
      <h2 class="project-tagline">This is a Captcha gem for Rails Application. It run ImageMagick command to draw Captcha image.</h2>
      <a href="https://github.com/huacnlee/rucaptcha" class="btn">View on GitHub</a>
      <a href="https://github.com/huacnlee/rucaptcha/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/huacnlee/rucaptcha/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="rucaptcha" class="anchor" href="#rucaptcha" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>RuCaptcha</h1>

<p><a href="https://badge.fury.io/rb/rucaptcha"><img src="https://badge.fury.io/rb/rucaptcha.svg" alt="Gem Version"></a>
<a href="https://travis-ci.org/huacnlee/rucaptcha"><img src="https://travis-ci.org/huacnlee/rucaptcha.svg" alt="Build Status"></a>
<a href="https://codeclimate.com/github/huacnlee/rucaptcha"><img src="https://codeclimate.com/github/huacnlee/rucaptcha/badges/gpa.svg" alt="Code Climate"></a></p>

<p>This is a Captcha gem for Rails Applications. It runs an ImageMagick command to draw Captcha image - so it has NO performance issues or memory leak issues. <strong>There is NO: RMagick</strong></p>

<h2>
<a id="example" class="anchor" href="#example" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Example</h2>

<p><img src="https://cloud.githubusercontent.com/assets/5518/15423974/b186b0d6-1eb2-11e6-9c0e-4cc3a66f32c8.png" alt="1">
<img src="https://cloud.githubusercontent.com/assets/5518/15423975/b1887b6e-1eb2-11e6-895f-5629f82697d3.png" alt="2">
<img src="https://cloud.githubusercontent.com/assets/5518/15423978/b18f08ee-1eb2-11e6-9670-c21dba290e04.png" alt="3">
<img src="https://cloud.githubusercontent.com/assets/5518/15423976/b18b6946-1eb2-11e6-8413-700ded157262.png" alt="4">
<img src="https://cloud.githubusercontent.com/assets/5518/15423977/b18e7c62-1eb2-11e6-96f7-5bd6981d4185.png" alt="5">
<img src="https://cloud.githubusercontent.com/assets/5518/15423979/b19175d4-1eb2-11e6-9417-7d496fb996b4.png" alt="6">
<img src="https://cloud.githubusercontent.com/assets/5518/15423980/b1caf944-1eb2-11e6-862e-78c0a9360b43.png" alt="7"></p>

<p>Idea by: <a href="https://ruby-china.org/topics/20558#reply4">https://ruby-china.org/topics/20558#reply4</a></p>

<p><a href="https://ruby-china.org/topics/27832">中文介绍和使用说明</a></p>

<h2>
<a id="feature" class="anchor" href="#feature" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Feature</h2>

<ul>
<li>Only need <code>ImageMagick</code>, No <code>RMagick</code>, No <code>mini_magick</code>;</li>
<li>For Rails Application;</li>
<li>Simple, Easy to use;</li>
<li>File Caching for performance.</li>
</ul>

<h2>
<a id="requirements" class="anchor" href="#requirements" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Requirements</h2>

<ul>
<li>ImageMagick 6.9+</li>
</ul>

<h4>
<a id="ubuntu" class="anchor" href="#ubuntu" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Ubuntu</h4>

<pre><code>sudo apt-get install imagemagick
</code></pre>

<h4>
<a id="mac-os-x" class="anchor" href="#mac-os-x" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Mac OS X</h4>

<div class="highlight highlight-source-shell"><pre>brew install imagemagick ghostscript</pre></div>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage</h2>

<p>Put rucaptcha in your <code>Gemfile</code>:</p>

<pre><code>gem 'rucaptcha'
</code></pre>

<p>Create <code>config/initializers/rucaptcha.rb</code></p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">RuCaptcha</span>.configure <span class="pl-k">do</span>
  <span class="pl-c"># Number of chars, default: 4</span>
  <span class="pl-v">self</span>.len <span class="pl-k">=</span> <span class="pl-c1">4</span>
  <span class="pl-c"># Image font size, default: 45</span>
  <span class="pl-v">self</span>.font_size <span class="pl-k">=</span> <span class="pl-c1">45</span>
  <span class="pl-c"># Cache generated images in file store, this is config files limit, default: 100</span>
  <span class="pl-c"># set 0 to disable file cache.</span>
  <span class="pl-v">self</span>.cache_limit <span class="pl-k">=</span> <span class="pl-c1">100</span>
  <span class="pl-c"># Custom captcha code expire time if you need, default: 2 minutes</span>
  <span class="pl-c"># self.expires_in = 120</span>
  <span class="pl-c"># Color style, default: :colorful, allows: [:colorful, :black_white]</span>
  <span class="pl-c"># self.style = :colorful</span>
<span class="pl-k">end</span></pre></div>

<p>Edit <code>config/routes.rb</code>, add the following code:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">Rails</span>.application.routes.draw <span class="pl-k">do</span>
  ...
  mount <span class="pl-c1">RuCaptcha</span>::<span class="pl-c1">Engine</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>/rucaptcha<span class="pl-pds">"</span></span>
  ...
<span class="pl-k">end</span></pre></div>

<p>Controller <code>app/controller/account_controller.rb</code></p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">AccountController<span class="pl-e"> &lt; ApplicationController</span></span>
  <span class="pl-k">def</span> <span class="pl-en">create</span>
    <span class="pl-smi">@user</span> <span class="pl-k">=</span> <span class="pl-c1">User</span>.<span class="pl-k">new</span>(params[<span class="pl-c1">:user</span>])
    <span class="pl-k">if</span> verify_rucaptcha?(<span class="pl-smi">@user</span>) <span class="pl-k">&amp;&amp;</span> <span class="pl-smi">@user</span>.save
      redirect_to root_path, <span class="pl-c1">notice:</span> <span class="pl-s"><span class="pl-pds">'</span>Sign up successed.<span class="pl-pds">'</span></span>
    <span class="pl-k">else</span>
      render <span class="pl-s"><span class="pl-pds">'</span>account/new<span class="pl-pds">'</span></span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>View <code>app/views/account/new.html.erb</code></p>

<div class="highlight highlight-text-html-erb"><pre>&lt;<span class="pl-ent">form</span>&gt;
  ...
  &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>form-group<span class="pl-pds">"</span></span>&gt;
    <span class="pl-pse">&lt;%=</span><span class="pl-s1"> rucaptcha_input_tag(<span class="pl-c1">class:</span> <span class="pl-s"><span class="pl-pds">'</span>form-control<span class="pl-pds">'</span></span>, <span class="pl-c1">placeholder:</span> <span class="pl-s"><span class="pl-pds">'</span>Input Captcha<span class="pl-pds">'</span></span>) </span><span class="pl-pse"><span class="pl-s1">%</span>&gt;</span>
    <span class="pl-pse">&lt;%=</span><span class="pl-s1"> rucaptcha_image_tag(<span class="pl-c1">alt:</span> <span class="pl-s"><span class="pl-pds">'</span>Captcha<span class="pl-pds">'</span></span>) </span><span class="pl-pse"><span class="pl-s1">%</span>&gt;</span>
  &lt;/<span class="pl-ent">div</span>&gt;
  ...
&lt;/<span class="pl-ent">form</span>&gt;</pre></div>

<p>And if you are use Devise, you can read this to add validation: <a href="https://github.com/huacnlee/rucaptcha/wiki/Working-with-Devise">RuCaptcha with Devise</a>.</p>

<h3>
<a id="write-your-test-skip-captcha-validation" class="anchor" href="#write-your-test-skip-captcha-validation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Write your test skip captcha validation</h3>

<p>for RSpec</p>

<div class="highlight highlight-source-ruby"><pre>describe <span class="pl-s"><span class="pl-pds">'</span>sign up and login<span class="pl-pds">'</span></span>, <span class="pl-c1">type:</span> <span class="pl-c1">:feature</span> <span class="pl-k">do</span>
  before <span class="pl-k">do</span>
    allow_any_instance_of(<span class="pl-c1">ActionController</span>::<span class="pl-c1">Base</span>).to receive(<span class="pl-c1">:verify_rucaptcha?</span>).and_return(<span class="pl-c1">true</span>)
  <span class="pl-k">end</span>

  it { ... }
<span class="pl-k">end</span></pre></div>

<p>for MiniTest</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">ActionDispatch::IntegrationTest</span>
  <span class="pl-k">def</span> <span class="pl-en">sign_in</span>(<span class="pl-smi">user</span>)
    <span class="pl-c1">ActionController</span>::<span class="pl-c1">Base</span>.any_instance.stubs(<span class="pl-c1">:verify_rucaptcha?</span>).returns(<span class="pl-c1">true</span>)
    post user_session_path \
         <span class="pl-s"><span class="pl-pds">'</span>user[email]<span class="pl-pds">'</span></span>    =&gt; user.email,
         <span class="pl-s"><span class="pl-pds">'</span>user[password]<span class="pl-pds">'</span></span> =&gt; user.password
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/huacnlee/rucaptcha">RuCaptcha</a> is maintained by <a href="https://github.com/huacnlee">huacnlee</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
